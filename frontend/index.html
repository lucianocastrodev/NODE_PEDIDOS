<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Painel de Pedidos CRUD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f4f6f9;
        }

        .card-pedido {
            transition: 0.2s ease;
        }

        .card-pedido:hover {
            transform: translateY(-3px);
        }

        .card-destaque {
            animation: destaque 1.5s;
        }

        @keyframes destaque {
            0% { border: 2px solid #ffc107; }
            100% { border: 0; }
        }

         .card-pedido {
        transition: 0.2s ease;
    }

    .card-pedido:hover {
        transform: translateY(-3px);
    }

    /* AnimaÃ§Ã£o de destaque */
    .card-destaque {
        animation: destaque 1s ease forwards;
    }

    @keyframes destaque {
        0% {
            transform: scale(1.05);
            background-color: #fff3cd; /* amarelo suave */
        }
        50% {
            transform: scale(1.1);
            background-color: #ffe08a; /* amarelo mais intenso */
        }
        100% {
            transform: scale(1);
            background-color: white;
        }
    }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ðŸ“¦ Painel de Pedidos</h2>
            <button class="btn btn-primary" onclick="novoPedido()">+ Novo Pedido</button>
        </div>

        <div class="row" id="listaPedidos"></div>
    </div>

    <!-- MODAL CRUD -->
    <div class="modal fade" id="modalPedido">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="pedidoId">
                    <div class="mb-3">
                        <label class="form-label">Cliente</label>
                        <input type="text" id="cliente" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Produto</label>
                        <input type="text" id="produto" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="quantidade" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select id="status" class="form-select">
                            <option value="novo">Novo</option>
                            <option value="preparando">Preparando</option>
                            <option value="entregue">Entregue</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary" id="btnSalvar">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const WS_URL = "ws://localhost:3000"; // WebSocket do Node
    const API_URL = "http://localhost:3000/pedidos"; // API REST
    const lista = document.getElementById("listaPedidos");
    const modalElement = document.getElementById("modalPedido");
    const modal = new bootstrap.Modal(modalElement);
    const btnSalvar = document.getElementById("btnSalvar");

    let pedidos = [];
    let ws;

    // ===============================
    // Carregar pedidos iniciais via REST
    // ===============================
    async function carregarPedidos() {
        try {
            const res = await fetch(API_URL);
            pedidos = await res.json();
            render(); // cria cards que ainda nÃ£o existem
        } catch (err) {
            console.error("Erro ao carregar pedidos:", err);
        }
    }
    carregarPedidos();

    // ===============================
    // WebSocket
    // ===============================
    function conectarWebSocket() {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => console.log("âœ… WebSocket conectado");
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.tipo === "novo_pedido") {
                pedidos.unshift(data.pedido);
                addCard(data.pedido);
            }

            if (data.tipo === "pedido_atualizado") {
                pedidos = pedidos.map(p => p.id === data.pedido.id ? data.pedido : p);
                atualizarCard(data.pedido);
            }

            if (data.tipo === "pedido_deletado") {
                pedidos = pedidos.filter(p => p.id !== data.id);
                deletarCard(data.id);
            }
        };

        ws.onclose = () => {
            console.log("âŒ WebSocket desconectado. Tentando reconectar...");
            setTimeout(conectarWebSocket, 2000);
        };

        ws.onerror = () => ws.close();
    }
    conectarWebSocket();

    // ===============================
    // Renderizar cards
    // ===============================
    function render() {
        pedidos.forEach(p => {
            if (!lista.querySelector(`.card-pedido[data-id='${p.id}']`)) {
                addCard(p);
            }
        });
    }

    function addCard(p) {
        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-lg-4 mb-3";
        col.innerHTML = `
            <div class="card shadow-sm card-pedido card-destaque" data-id="${p.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5>#${p.id} - ${p.cliente}</h5>
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick='editar(${JSON.stringify(p)})'>Editar</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deletar(${p.id})">Excluir</a></li>
                            </ul>
                        </div>
                    </div>
                    <p class="mb-1"><strong>Produto:</strong> ${p.produto}</p>
                    <p class="mb-1"><strong>Quantidade:</strong> ${p.quantidade}</p>
                    <span class="badge bg-${corStatus(p.status)}">${p.status}</span>
                </div>
            </div>
        `;
        lista.prepend(col);

        const card = col.querySelector(".card-pedido");
        card.addEventListener("animationend", () => card.classList.remove("card-destaque"));
    }

    function atualizarCard(p) {
        const card = lista.querySelector(`.card-pedido[data-id='${p.id}']`);
        if (!card) {
            addCard(p);
            return;
        }

        let mudou = false;

        const h5 = card.querySelector("h5");
        if (h5.textContent !== `#${p.id} - ${p.cliente}`) {
            h5.textContent = `#${p.id} - ${p.cliente}`;
            mudou = true;
        }

        const produtoP = card.querySelector("p:nth-of-type(1)");
        if (produtoP.textContent !== `Produto: ${p.produto}`) {
            produtoP.innerHTML = `<strong>Produto:</strong> ${p.produto}`;
            mudou = true;
        }

        const quantidadeP = card.querySelector("p:nth-of-type(2)");
        if (quantidadeP.textContent !== `Quantidade: ${p.quantidade}`) {
            quantidadeP.innerHTML = `<strong>Quantidade:</strong> ${p.quantidade}`;
            mudou = true;
        }

        const badge = card.querySelector("span");
        if (badge.textContent !== p.status || !badge.classList.contains(`bg-${corStatus(p.status)}`)) {
            badge.textContent = p.status;
            badge.className = `badge bg-${corStatus(p.status)}`;
            mudou = true;
        }

        if (mudou) {
            card.classList.add("card-destaque");
            card.addEventListener("animationend", () => card.classList.remove("card-destaque"));
        }
    }

    function deletarCard(id) {
        const card = lista.querySelector(`.card-pedido[data-id='${id}']`);
        if (card) card.parentElement.remove();
    }

    function corStatus(status) {
        if (status === "novo") return "primary";
        if (status === "preparando") return "warning";
        if (status === "entregue") return "success";
        return "secondary";
    }

    // ===============================
    // CRUD
    // ===============================
    function novoPedido() {
        limparCampos();
        modal.show();
    }

    function editar(p) {
        document.getElementById("pedidoId").value = p.id;
        document.getElementById("cliente").value = p.cliente;
        document.getElementById("produto").value = p.produto;
        document.getElementById("quantidade").value = p.quantidade;
        document.getElementById("status").value = p.status;
        modal.show();
    }

    btnSalvar.addEventListener("click", async () => {
        btnSalvar.disabled = true;

        const id = document.getElementById("pedidoId").value;
        const cliente = document.getElementById("cliente").value;
        const produto = document.getElementById("produto").value;
        const quantidade = document.getElementById("quantidade").value;
        const status = document.getElementById("status").value;

        try {
            if (id) {
                await fetch(`${API_URL}/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cliente, produto, quantidade, status })
                });
            } else {
                await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cliente, produto, quantidade })
                });
            }
            modal.hide();
            limparCampos();
        } catch {
            alert("Erro ao salvar pedido!");
        } finally {
            btnSalvar.disabled = false;
        }
    });

    async function deletar(id) {
        if (!confirm("Deseja excluir este pedido?")) return;
        try {
            await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        } catch {
            alert("Erro ao deletar pedido!");
        }
    }

    function limparCampos() {
        document.getElementById("pedidoId").value = "";
        document.getElementById("cliente").value = "";
        document.getElementById("produto").value = "";
        document.getElementById("quantidade").value = "";
        document.getElementById("status").value = "novo";
    }
</script>

</body>

</html>
